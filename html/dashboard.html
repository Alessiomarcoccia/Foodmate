<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
        crossorigin="anonymous"></script>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <script src="https://kit.fontawesome.com/d66b1f16f0.js" crossorigin="anonymous"></script>    
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
   
    <link href="../components/sidebar-style.css" rel="stylesheet">
    <title>Foodmate</title>
</head>

<body>

    <div id="sidebar-container"></div>
    
    <!-- Page content -->
    <div class="content">
        <!-- Header -->
        <div class="row">
            <div class="col-4">
                <h1>Le tue dispense</h1>
            </div>

        </div>
        <!-- HEADER -->
        <div class="row" style="margin-top: 10px;">
            <!-- BOTTONI DISPENSE -->
            <div class="col-10" id="user-fridges"></div>
            <div class="col-2">
                <!-- BOTTONE NUOVA DISPENSA -->
                <button type="button" class="btn btn-outline-primary" data-bs-toggle="modal"
                    data-bs-target="#nuovaDispensa">
                    Nuova dispensa
                </button>
                <!-- POP UP NUOVA DISPENSA -->
                <div class="modal fade" id="nuovaDispensa">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Nuova Dispensa</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <form action="../php/nuovaDispensa.php" method="post" id="form-nuova-dispensa">
                                    <div class="mb-3">
                                        <label for="nomeDispensa" class="form-label">Name</label>
                                        <input type="text" class="form-control" id="nomeDispensa" name="nomeDispensa"
                                            maxlength="40" required>
                                    </div>
                                </form>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                <button type="submit" class="btn btn-primary" form="form-nuova-dispensa">Submit</button>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
        <!-- CONTENUTO DELLA DISPENSA -->
        <div class="row">
            <div class="col" id="contenutoDispensa"></div>

            <!-- POP UP NUOVA PROVVISTA -->
            <div class="modal fade" id="nuovaProvvista">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Nuova Provvista</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <form id="form-nuova-provvista" action="../php/nuovaProvvista.php" method="post">
                                <div class="mb-3">
                                    <label for="nomeProvvista" class="form-label">Name</label>
                                    <input type="text" class="form-control" id="nomeProvvista" name="nomeProvvista"
                                        maxlength="40" required>

                                    <label for="expDate" class="form-label">Expiration date</label>
                                    <input type="date" class="form-control" id="expDate" name="expDate" required>

                                    <label for="quantita" class="form-label">Quantity</label>
                                    <input type="number" oninput="if(value<=0) value=1" class="form-control" id="quantita" name="quantita" required>

                                    <label for="tipoProvvista" class="form-label">Type</label>
                                    <select class="form-select" id="tipoProvvista" name="tipoProvvista">
                                        <option selected>Open this select menu</option>
                                        <option value="carne">Carne</option>
                                        <option value="dolce">Dolce</option>
                                        <option value="formaggio">Formaggio</option>
                                        <option value="frutta">Frutta</option>
                                        <option value="pesce">Pesce</option>
                                        <option value="uova">Uova</option>
                                        <option value="verdura">Verdura</option>
                                    </select>
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="chiudiFormProvvista">Close</button>
                            <button type="submit" class="btn btn-primary" form="form-nuova-provvista">Submit</button>
                        </div>
                    </div>
                </div>
            </div>

        </div>

    </div>
</body>

<script>
    
    //funzione che gestisce il caricamento del sidebar
    $(document).ready(function () {
        $.ajax({
            url: '../components/sidebar-component.php',
            method: 'GET',
            dataType: 'text',
            success(data) {
                $('#sidebar-container').html(data);
            },
            error: function (jqXHR, textStatus, errorThrown) {
                console.log('Error: ' + errorThrown);
                console.log("Status: " + textStatus);
                console.log("Response Text: " + jqXHR.responseText);
            }
        });
    });

    $(document).ready(function () {
        // Richiesta AJAX per ottenere i frigoriferi dell'utente
        $.ajax({
            url: '../php/get_user_fridges.php',
            type: 'GET',
            dataType: 'json',
            success: function (data) {
                $.each(data, function (index, fridge) {
                    //Crea un nuovo bottone per ogni frigorifero
                    var button = $('<button/>', {
                        text: fridge.nome,
                        class: 'btn btn-outline-success bottoneFrigo',
                        id: fridge.nome
                    });

                    //Appende il bottone al contenitore
                    $('#user-fridges').append(button);

                });
            },
            error: function (jqXHR, textStatus, errorThrown) {
                console.log('Error: ' + errorThrown);
                console.log("Status: " + textStatus);
                console.log("Response Text: " + jqXHR.responseText);
            }
        });
    });

    /* Questa funzione aggiunge un evento su ogni bottoneFrigo.In particolare quando il bottone è cliccato,
    viene caricato il contenuto del frigo nell'elemento con id = contenutoDispensa. */
    $(document).on('click', '.bottoneFrigo', function () {
        var fridgeName = $(this).text();
        $.ajax({
            url: '../php/get_fridge_content.php',
            type: 'GET',
            data: {
                nomeFrigorifero: $(this).text(),
            },
            dataType: 'json',
            success: function (data) {
                $('#contenutoDispensa').empty();
                var card = $('<div/>', {
                    class: 'card'
                });
                var cardFooter = $('<div/>', {
                    class: 'card-footer'
                });
                var button = $('<button/>', {
                    type: 'button',
                    class: 'btn btn-primary',
                    text: 'Aggiungi',
                    'data-bs-toggle': 'modal',
                    'data-bs-target': '#nuovaProvvista'
                });
                var cardBody = $('<div/>', {
                    class: 'card-body'
                });
                var list = $('<ul/>', {
                    class: 'list-group list-group-flush '
                });
                $.each(data, function (index, item) {
                    var listItem = $('<li/>', {
                        class: 'list-group-item',
                        id: item.id,
                    });
                    var icon = $('<i/>', {
                        class: item.tipologia
                    });
                    var span = $('<span/>', {
                        class: 'item-info',
                        text: 'Qty: ' + item.quantita + ' ' + 'Exp: ' + item.datascadenza
                    });

                    var deleteButton = $('<button/>', {
                        type: 'button',
                        class: 'btn btn-outline-danger bottoneEliminaProvvista',
                        text: 'Elimina'
                    });

                    listItem.append(icon);
                    listItem.append('<strong>' + item.nome + '</strong;> ' + '&nbsp;');
                    listItem.append(span);
                    listItem.append(deleteButton);
                    list.append(listItem);
                    cardBody.append(list);
                });
                cardFooter.append(button);
                card.append(cardBody);
                card.append(cardFooter);
                $('#contenutoDispensa').append(card);
            },
            error: function (jqXHR, textStatus, errorThrown) {
                console.log('Error: ' + errorThrown);
                console.log("Status: " + textStatus);
                console.log("Response Text: " + jqXHR.responseText);
            }
        });
    });

    /*Funzione che gestisce l'aggiunta di una nuova provvista.Quando viene cliccato il tasto submit del form,l'invio delle informazioni al server è gestito da
    ajax e non dal form.*/
    $(document).ready(function () {
        $('#form-nuova-provvista').submit(function (event) {
            event.preventDefault();
            $.ajax({
                url: $(this).attr('action'),
                type: $(this).attr('method'),
                data: $(this).serialize(),
                dataType: 'json',
                success: function (data) {
                    //riapre il frigo in cui è stata aggiunta la provvista
                    var bottone = $(".bottoneFrigo#" + data.nomeFrigorifero);
                    bottone.click();
                    //svuota il form 
                    $('#form-nuova-provvista')[0].reset();
                    //chiude il form
                    $('#chiudiFormProvvista').click();
                },
                error: function (jqXHR, textStatus, errorThrown) {
                    console.log('Error: ' + errorThrown);
                    console.log("Status: " + textStatus);
                    console.log("Response Text: " + jqXHR.responseText);
                }
            });
        });
    });

    /*Funzione che gestisce l'eliminazione di una provvista.Quando viene cliccato il bottone elimina,viene inviata una richiesta ajax al server per eliminare*/
    $(document).on('click', ".bottoneEliminaProvvista", function () {
        $.ajax({
            url: '../php/eliminaProvvista.php',
            type: 'POST',
            data: {
                idProvvista: $(this).parent().attr('id')
            },
            dataType: 'json',
            success: function (data) {
                //riclicca il bottone del frigo per aggiornare il contenuto della pagina
                var bottone = $(".bottoneFrigo#" + data.nomeFrigorifero);
                bottone.click();
            },
            error: function (jqXHR, textStatus, errorThrown) {
                console.log('Error: ' + errorThrown);
                console.log("Status: " + textStatus);
                console.log("Response Text: " + jqXHR.responseText);
            }
        });
    });

    //funzione che impedisce di inserire date di scadenza precedenti a quella attuale
    $(function() {
        var date = new Date();
        var year = date.getFullYear();
        var month = date.getMonth() +1;
        if(month < 10){
            month = '0' + month;
        }
        var day = date.getDate();
        if (day < 10){
            day = '0' + day;
        }
        var time = year + '-' + month + '-' + day;
        $('#expDate').attr('min', time);
    })


</script>


<style>
    /* SIDEBAR STYLE */
    .sidebar {
        margin: 0;
        padding-top: 20px;
        width: 200px;
        background-color: #2f855a;
        position: fixed;
        height: 100%;
        overflow: auto;
        align-content: center;
    }

    .sidebar-brand {
        font-size: 27px;
    }

    .sidebar-nav {
        list-style: none;
        padding: 0;
    }

    .sidebar-nav li {
        text-indent: 20px;
        line-height: 40px;
    }

    .sidebar-nav li a {
        display: block;
        text-decoration: none;
        color: #fff;
    }

    .sidebar-nav li a:hover {
        text-decoration: none;
        background: rgba(255, 255, 255, 0.2);
    }

    .sidebar-nav>.sidebar-brand a:hover {
        background: none;
    }

    /* PAGE CONTENT WRAPPER STYLE */

    div.content {
        margin-left: 200px;
        padding: 1px 16px;
        /* width: 100%; */
    }

    /* DELETE BUTTONS STYLE */

    li button {
        float: right;
    }

    /* FRIDGE BUTTON STYLE */

    .bottoneFrigo {
        margin-right: 5px;
    }

    /* FRIDGE CONTENT STYLE */

    #contenutoDispensa {
        margin-top: 20px;
    }

    /* ICON STYLE */

    .frutta::before {
        content: "\f5d1";
        font-family: "Font Awesome 6 Free";
        font-weight: 900;
        font-style: normal;
        margin-right: 20px;
        float: left;
    }

    .verdura::before {
        content: "\f06c";
        font-family: "Font Awesome 6 Free";
        font-weight: 900;
        font-style: normal;
        margin-right: 20px;
    }

    

    /*
    /* SIDEBAR MEDIA QUERIES */

   /*  @media screen and (max-width: 700px) {
        .sidebar {
            width: 100%;
            height: auto;
            position: relative;
        }

        .sidebar a {
            float: left;
        }

        div.content {
            margin-left: 0;
        }
    }

    @media screen and (max-width: 400px) {
        .sidebar a {
            text-align: center;
            float: none;
        }
    } */
</style>

</html>