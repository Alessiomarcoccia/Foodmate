<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
        crossorigin="anonymous"></script>
    <script src="https://kit.fontawesome.com/d66b1f16f0.js" crossorigin="anonymous"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <link href="../components/sidebar-style.css" rel="stylesheet">
    <title>Foodmate</title>
</head>
<body>
    
    <div id="sidebar-container"></div>

    <!-- Page content -->
    <div class="content">
        <!-- Header -->
        <div class="row">
            <div class="col-md-12">
                <h1>La Tua Lista della Spesa</h1> 
            </div>
        </div>

        <!-- Bottone Aggiornamento -->
        <div>
            <button class="aggiornaListaSpesa">aggiorna</button>
        </div>

        <!-- INPUT AGGIUNGI NUOVA PROVVISTA PER LISTA SPESA -->
        <div class="container mt-3">
            <form id="form-aggiungiProvvista", action="../php/aggiungiListaSpesa.php" method="post">
                <div class="row">
                    <div class="col">
                        Prodotto:
                        <input type="text" class="form-control" id="nomeProvvista" name="nomeProvvista" value="Aggiungi Prodotto..." onfocus="this.value=''" maxlength="40" required>
                    </div>
                </div>
                <div class="row">
                    <div class="col">
                        Descizione:
                        <textarea class="form-control" id="descrizioneProvvista" name="descrizioneProvvista" value="Inserisci una descizione (Opzionale)" onfocus="this.value=''" rows="2"></textarea>
                    </div>
                </div><br>
                <div class="row">
                    <div class="col">
                        <button type="submit" class="btn btn-primary" id="aggiungiProvvista">Aggiungi</button>
                    </div>
                </div>
            </form>
        </div><br>

        <!-- List -->
        <div id="listaSpesa"></div><br>
        
        <!-- Buttoni Sposta in Frigo & Elimina Spesa -->
        <div class="col" id="button-container" style="display: none;">
            <button class="btn btn-success" id="btnSpesaInFrigo">Sposta in Frigo</button>
            <button class="btn btn-danger" id="btnEliminaSpesa">Elimina Spesa</button>
        </div>

        <!-- POP-UP PER SPOSTARE IN FRIGO LA SPESA SELEZIONATA -->
        <div class="modal fade" id="popupSpesaInFrigo">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Spesa In Frigo</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <form id="form-Spesa-In-Frigo" action="../php/aggiungiListaInFrigo.php" method="post">
                        <div class="modal-body">
                            <div class="mb-3">
                                <h5 id="titoloPopup"></h5>

                                <label for="expDate" class="form-label">Expiration date</label>
                                <input type="date" class="form-control" id="expDate" name="expDate" required>

                                <label for="quantita" id="quantita" class="form-label">Quantity</label>
                                <input type="number" oninput="if(value<=0) value=1" class="form-control" id="quantita" name="quantita" required>

                                <label for="tipoProvvista" class="form-label">Type</label>
                                <select class="form-select" id="tipoProvvista" name="tipoProvvista" required>
                                    <option selected>Open this select menu</option>
                                    <option value="carne">Carne</option>
                                    <option value="dolce">Dolce</option>
                                    <option value="formaggio">Formaggio</option>
                                    <option value="frutta">Frutta</option>
                                    <option value="pesce">Pesce</option>
                                    <option value="uova">Uova</option>
                                    <option value="verdura">Verdura</option>
                                </select>

                                <label for="nomeFrigo" class="form-label"></label>
                                <select class="form-select" id="nomeFrigo" name="nomeFrigo" required>
                                    <option value="">Seleziona un Frigo</option>
                                </select>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="submit" class="btn btn-primary" id="inviaSpesaInFrigo">Submit</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>


    </div>

    
<script>
    //funzione che gestisce il caricamento del sidebar
    $(document).ready(function () {
        $.ajax({
            url: '../components/sidebar-component.php',
            method: 'GET',
            dataType: 'text',
            success(data) {
                $('#sidebar-container').html(data);
            },
            error: function (jqXHR, textStatus, errorThrown) {
                console.log('Error: ' + errorThrown);
                console.log("Status: " + textStatus);
                console.log("Response Text: " + jqXHR.responseText);
            }
        });
    });

    // stampa lista provviste gia presenti nel database
    $(document).ready( function() {
        $.ajax({
            url: '../php/get_listaSpesa.php',
            type: 'GET',
            dataType: 'json',
            success: function (data) {
                stampa(data);
            },
            error: function (jqXHR, textStatus, errorThrown) {
                    console.log('Error: ' + errorThrown);
                    console.log("Status: " + textStatus);
                    console.log("Response Text: " + jqXHR.responseText);
            }
        });
    });

    function stampa(data) {
        $('#listaSpesa').empty();
        var listaSpesa = $('#listaSpesa');
        $.each(data, function (index, item) {
            var container = $('<div>').addClass('container mt-3');
            var card = $('<div>').addClass('card');
            var cardBody = $('<div>').addClass('card-body');
            var cardNome = $('<h1>').addClass('card-nome');
            var cardDescrizione = $('<p>').addClass('card-descrizione'); 
            var check = $('<input>').addClass('form-check-input select').attr('type', 'checkbox').attr('id', item.id);
            cardBody.append(cardNome.text(item.nome));
            cardBody.append(check);
            cardBody.append(cardDescrizione.text(item.descrizione));
            card.append(cardBody);
            container.append(card);
            $('#listaSpesa').append(card);
        });
    }

    // aggiunta nuovo provviste alla lista della spesa
    $(document).ready( function() {
        $('#form-aggiungiProvvista').submit(function (event) {
            event.preventDefault();
            $.ajax({
                url: $(this).attr('action'),
                type: $(this).attr('method'),
                data: $(this).serialize(),
                dataType: 'json',
                success: function (data) {
                    $('#nomeProvvista').val('');
                    $('#descrizioneProvvista').val('');
                    stampa(data);
                },
                error: function (jqXHR, textStatus, errorThrown) {
                    console.log('Error: ' + errorThrown);
                    console.log("Status: " + textStatus);
                    console.log("Response Text: " + jqXHR.responseText);
                }
            })
        }); 
    });  

    // Rimozione Con CheckBox
    $(document).ready(function() {
        $(document).on('click', '#btnEliminaSpesa', function() {
            var idP = [];
            $("input[type='checkbox']:checked").each(function() {
                idP.push($(this).attr("id"));
            }); 
            $.ajax({
                url: '../php/eliminaListaSpesa.php',
                type: 'POST',
                data: {
                    idProvviste: idP,
                },
                success: function (data) {
                    stampa(data);
                    if (data.length === 0) {
                        $("#button-container").fadeOut();
                    }
                },
                error: function (jqXHR, textStatus, errorThrown) {
                    console.log('Error: ' + errorThrown);
                    console.log("Status: " + textStatus);
                    console.log("Response Text: " + jqXHR.responseText);
                }

            })
        });
    });

    // Script per recuperare nel database i frighi disponibili e impostarli come option nella select
    $(document).ready(function () {
        $.ajax({
            url: '../php/get_user_fridges.php',
            type: 'get',
            dataType: 'json',
            success: function (data) {
                $.each(data, function (index, frigo) {
                    $('#nomeFrigo').append('<option value="' + frigo.nome + '">' + frigo.nome + '</option>');
                });
            },
            error: function (jqXHR, textStatus, errorThrown) {
                console.log('Error: ' + errorThrown);
                console.log("Status: " + textStatus);
                console.log("Response Text: " + jqXHR.responseText);
            }
        });
    });

    // popup con form per aggiungere le nuove provviste al frigo
    $(document).ready(function() {
        $(document).on('click', '#btnSpesaInFrigo', function() {
            var idP = [];
            var name = [];
            $("input[type='checkbox']:checked").each(function() {
                idP.push($(this).attr("id"));
                name.push($(this).siblings(".card-nome").text());
            });
            var indice = 0;
            $('#titoloPopup').text(name[indice]); 
            $('#popupSpesaInFrigo').modal('show'); 
            $(document).on('submit', '#form-Spesa-In-Frigo', function(event) {
                event.preventDefault();
                var formData = $(this).serialize();
                var nomeFrigo = $('#nomeFrigo').val();
                var additionalData = {
                    id: idP[indice],
                    name: name[indice],
                    nomeFrigo: nomeFrigo
                };
                var requestData = formData + '&' + $.param(additionalData);
                $.ajax({
                    url: $(this).attr('action'),
                    type: $(this).attr('method'),
                    data: requestData,
                    dataType: 'json',
                    success: function (data) {
                        stampa(data);
                        if (data.length === 0) {
                        $("#button-container").fadeOut();
                    }
                    },
                    error: function (jqXHR, textStatus, errorThrown) {
                        console.log('Error: ' + errorThrown);
                        console.log("Status: " + textStatus);
                        console.log("Response Text: " + jqXHR.responseText);
                    }
                });
                indice++;
                if (indice < idP.length) {
                    $('#titoloPopup').text(name[indice]);
                    $('#quantita').val(0);
                    $('#expDate').val('');
                    $('#tipoProvvista').val('');
                } else {
                    $('#popupSpesaInFrigo').modal('hide');
                }
            });
        });
    });


    // Controllo checkbox per far apparire i tasti "Aggiungi a Frigorifero" e "Elimina Spesa".
    $(document).ready(function() {
        $(document).on('change', 'input[type="checkbox"]', function() {
            var checked = $("input[type='checkbox']:checked").length > 0;
            if (checked) {
                $("#button-container").fadeIn(); // Mostra il container dei bottoni con animazione di fade in
            } else {
                $("#button-container").fadeOut(); // Nascondi il container dei bottoni con animazione di fade out
            }
        });
    });


    //funzione che impedisce di inserire date di scadenza precedenti a quella attuale
    $(function() {
        var date = new Date();
        var year = date.getFullYear();
        var month = date.getMonth() +1;
        if(month < 10){
            month = '0' + month;
        }
        var day = date.getDate();
        if (day < 10){
            day = '0' + day;
        }
        var time = year + '-' + month + '-' + day;
        $('#expDate').attr('min', time);
    })




</script>
<style>
    
    .select {
        float: right;
    }

    .select {
        display: inline-block;
    }

    #listaSpesa {
        padding-left: 12px;
        padding-right: 12px;
    } 

    .card-descrizione {
        display: inline-block;
    }

    .aggiornaListaSpesa {
        display: none;
    }

    #btnSpesaInFrigo {
        margin-left: 10px;
    }    


</style>
</body>
</html>