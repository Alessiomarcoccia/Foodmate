<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
        crossorigin="anonymous"></script>
    <script src="https://kit.fontawesome.com/d66b1f16f0.js" crossorigin="anonymous"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>

    <title>Foodmate</title>
</head>

<body>
    <div class="sidebar">
        <ul class="sidebar-nav">
            <li class="sidebar-brand">
                <a href="/">
                    <strong>Foodmate</strong>
                </a>
            </li>
            <li>
                <a href="/dashboard">
                    <i class="fas fa-home"></i>
                    Home
                </a>
            </li>
            <li>
                <a href="#">
                    <i class="fas fa-user"></i>
                    Profilo
                </a>
            </li>
            <li>
                <a href="#">
                    <i class="fa-sharp fa-solid fa-chart-simple"></i>
                    Statistiche
                </a>
            </li>
        </ul>
    </div>
    <!-- Page content -->
    <div class="content">
        <!-- Header -->
        <div class="row">
            <div class="col-4">
                <h1>Le tue dispense</h1>
            </div>

        </div>
        <!-- HEADER -->
        <div class="row">
            <!-- BOTTONI DISPENSE -->
            <div class="col-10" id="user-fridges"></div>
            <div class="col-2">
                <!-- BOTTONE NUOVA DISPENSA -->
                <button type="button" class="btn btn-outline-success" data-bs-toggle="modal"
                    data-bs-target="#nuovaDispensa">
                    Nuova dispensa
                </button>
                <!-- POP UP NUOVA DISPENSA -->
                <div class="modal fade" id="nuovaDispensa">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Nuova Dispensa</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <form action="nuovaDispensa.php" method="post" id="form-nuova-dispensa">
                                    <div class="mb-3">
                                        <label for="nomeDispensa" class="form-label">Name</label>
                                        <input type="text" class="form-control" id="nomeDispensa" name="nomeDispensa"
                                            maxlength="40" required>
                                    </div>
                                </form>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                <button type="submit" class="btn btn-primary" form="form-nuova-dispensa">Submit</button>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
        <!-- CONTENUTO DELLA DISPENSA -->
        <div class="row">
            <div class="col" id="contenutoDispensa"></div>

            <!-- POP UP NUOVA PROVVISTA -->
            <div class="modal fade" id="nuovaProvvista">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Nuova Provvista</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <form id="form-nuova-provvista">
                                <div class="mb-3">
                                    <label for="nomeProvvista" class="form-label">Name</label>
                                    <input type="text" class="form-control" id="nomeProvvista" name="nomeProvvista"
                                        maxlength="40" required>

                                    <label for="expDate" class="form-label">Expiration date</label>
                                    <input type="date" class="form-control" id="expDate" name="expDate" required>

                                    <label for="quantita" class="form-label">Quantity</label>
                                    <input type="number" class="form-control" id="quantita" name="quantita" required>

                                    <label for="tipoProvvista" class="form-label">Type</label>
                                    <select class="form-select" id="tipoProvvista" name="tipoProvvista">
                                        <option selected>Open this select menu</option>
                                        <option value="carne">Carne</option>
                                        <option value="dolce">Dolce</option>
                                        <option value="formaggio">Formaggio</option>
                                        <option value="frutta">Frutta</option>
                                        <option value="pesce">Pesce</option>
                                        <option value="uova">Uova</option>
                                        <option value="verdura">Verdura</option>
                                    </select>
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                            <button type="submit" class="btn btn-primary" form="form-nuova-provvista" id="inviaFormProvvista">Submit</button>
                        </div>
                    </div>
                </div>
            </div>

        </div>

    </div>
</body>

<script>
    $(document).ready(function () {
        // Richiesta AJAX per ottenere i frigoriferi dell'utente
        $.ajax({
            url: 'get_user_fridges.php',
            type: 'GET',
            dataType: 'json',
            success: function (data) {
                $.each(data, function (index, fridge) {
                    //Crea un nuovo bottone per ogni frigorifero
                    var button = $('<button/>', {
                        text: fridge.nome,
                        class: 'btn btn-outline-success bottoneFrigo',
                        id: fridge.nome
                    });

                    //Appende il bottone al contenitore
                    $('#user-fridges').append(button);

                });
            },
            error: function (jqXHR, textStatus, errorThrown) {
                console.log('Error: ' + errorThrown);
                console.log("Status: " + textStatus);
                console.log("Response Text: " + jqXHR.responseText);
            }
        });
    });

    /* Questa funzione aggiunge un evento su ogni bottoneFrigo.In particolare quando il bottone Ã¨ cliccato,viene caricato il contenuto del frigo nell'elemento
    con id = contenutoDispensa. */
    $(document).on('click', '.bottoneFrigo', function () {
        var fridgeName = $(this).text();
        $.ajax({
            url: 'get_fridge_content.php',
            type: 'GET',
            data: {
                nomeFrigorifero: $(this).text(),
            },
            dataType: 'json',
            success: function (data) {
                $('#contenutoDispensa').empty();
                var card = $('<div/>', {
                    class: 'card'
                });
                var cardFooter = $('<div/>', {
                    class: 'card-footer'
                });
                var button = $('<button/>', {
                    type: 'button',
                    class: 'btn btn-primary',
                    text: 'Aggiungi',
                    'data-bs-toggle': 'modal',
                    'data-bs-target': '#nuovaProvvista'
                });
                var cardBody = $('<div/>', {
                    class: 'card-body'
                });
                var list = $('<ul/>', {
                    class: 'list-group list-group-flush'
                });
                $.each(data, function (index, item) {
                    var listItem = $('<li/>', {
                        class: 'list-group-item',
                    });
                    var icon = $('<i/>', {
                        class: item.tipologia
                    });
                    var span = $('<span/>', {
                        class: 'item-info',
                        text: 'Qty: ' + item.quantita + ' ' + 'Exp: ' + item.datascadenza
                    });

                    var deleteButton = $('<button/>', {
                        type: 'button',
                        class: 'btn btn-outline-danger',
                        text: 'Elimina'
                    });

                    listItem.append(icon);
                    listItem.append('<strong>' + item.nome + '</strong;> ' + '&nbsp;');
                    listItem.append(span);
                    listItem.append(deleteButton);
                    list.append(listItem);
                    cardBody.append(list);
                });
                cardFooter.append(button);
                card.append(cardBody);
                card.append(cardFooter);
                $('#contenutoDispensa').append(card);
            },
            error: function (jqXHR, textStatus, errorThrown) {
                console.log('Error: ' + errorThrown);
                console.log("Status: " + textStatus);
                console.log("Response Text: " + jqXHR.responseText);
            }
        });
    });

    

    /* quando il bottone con id inviaFormProvvista viene cliccato,viene inviata una richiesta ajax a nuova provvista.php con i dati inseriti nel form con id form-nuova-provvista. 
    lo script php ritorna un id di un frigorifero sotto forma di json.Se la chiamata ajax ha successo viene cliccato il bottone con id uguale a quello ritornato dallo script php*/
    $(document).on('click', '#inviaFormProvvista', function () {
        $.ajax({
            url: 'nuovaProvvista.php',
            type: 'POST',
            data: $('#form-nuova-provvista').serialize(),
            dataType: 'json',
            success: function (data) {
                var fridgeId = data.nomeFrigorifero;
                var fridgeButton = document.getElementById(fridgeId);
                if (fridgeButton) {
                    fridgeButton.click();
                }
            },
            error: function (jqXHR, textStatus, errorThrown) {
                console.log('Error: ' + errorThrown);
                console.log("Status: " + textStatus);
                console.log("Response Text: " + jqXHR.responseText);
            }
        });
    });



   /*  function clickFridgeButton(fridgeId) {
        var fridgeButton = document.getElementById(fridgeId);
        if (fridgeButton) { fridgeButton.click(); }
    }

    var urlParams = new URLSearchParams(window.location.search);
    if (urlParams.has('fridgeId')) {
        var fridgeId = urlParams.get('fridgeId');
        clickFridgeButton(fridgeId);
    }
 */


</script>


<style>
    /* SIDEBAR STYLE */
    .sidebar {
        margin: 0;
        padding-top: 20px;
        width: 200px;
        background-color: #2f855a;
        position: fixed;
        height: 100%;
        overflow: auto;
        align-content: center;
    }

    .sidebar-brand {
        font-size: 27px;
    }

    .sidebar-nav {
        list-style: none;
        padding: 0;
    }

    .sidebar-nav li {
        text-indent: 20px;
        line-height: 40px;
    }

    .sidebar-nav li a {
        display: block;
        text-decoration: none;
        color: #fff;
    }

    .sidebar-nav li a:hover {
        text-decoration: none;
        background: rgba(255, 255, 255, 0.2);
    }

    .sidebar-nav>.sidebar-brand a:hover {
        background: none;
    }

    /* PAGE CONTENT WRAPPER STYLE */

    div.content {
        margin-left: 200px;
        padding: 1px 16px;
    }

    /* DELETE BUTTONS STYLE */

    li button {
        float: right;
    }

    /* FRIDGE BUTTON STYLE */

    .bottoneFrigo {
        margin-right: 5px;
    }

    /* FRIDGE CONTENT STYLE */

    #contenutoDispensa {
        margin-top: 20px;
    }

    /* ICON STYLE */

    .frutta::before {
        content: "\f5d1";
        font-family: "Font Awesome 6 Free";
        font-weight: 900;
        font-style: normal;
        margin-right: 20px;
        float: left;
    }

    .verdura::before {
        content: "\f06c";
        font-family: "Font Awesome 6 Free";
        font-weight: 900;
        font-style: normal;
        margin-right: 20px;
    }

    /* SIDEBAR MEDIA QUERIES */

    @media screen and (max-width: 700px) {
        .sidebar {
            width: 100%;
            height: auto;
            position: relative;
        }

        .sidebar a {
            float: left;
        }

        div.content {
            margin-left: 0;
        }
    }

    @media screen and (max-width: 400px) {
        .sidebar a {
            text-align: center;
            float: none;
        }
    }
</style>